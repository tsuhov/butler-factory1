name: üöÄ Content Factory (Iron Matrix)

on:
  workflow_dispatch:
    inputs:
      batch_size_per_thread:
        description: '–°–∫–æ–ª—å–∫–æ —Å—Ç–∞—Ç–µ–π –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ö–ê–ñ–î–´–ú –ø–æ—Ç–æ–∫–æ–º?'
        required: true
        default: '10'
      threads:
        description: '–°–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –∑–∞–ø—É—Å—Ç–∏—Ç—å –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û (1-20)?'
        required: true
        default: '5'

jobs:
  # --- –ó–ê–î–ê–ß–ê ‚Ññ1: –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å ---
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
    steps:
      - name: Create thread matrix
        id: set_matrix
        run: |
          MAX_THREADS=20 # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
          REQUESTED_THREADS=${{ github.event.inputs.threads }}
          
          if (( REQUESTED_THREADS > MAX_THREADS )); then
            echo "::warning::–ó–∞–ø—Ä–æ—à–µ–Ω–æ –±–æ–ª—å—à–µ –ø–æ—Ç–æ–∫–æ–≤ (${REQUESTED_THREADS}), —á–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ –∫–ª—é—á–µ–π (${MAX_THREADS}). –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${MAX_THREADS}."
            REQUESTED_THREADS=$MAX_THREADS
          fi

          # –°–æ–∑–¥–∞–µ–º JSON-–º–∞—Å—Å–∏–≤ –æ—Ç 1 –¥–æ N
          MATRIX=$(jq -cn --argjson n "$REQUESTED_THREADS" '[range(1; $n + 1)]')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # --- –ó–ê–î–ê–ß–ê ‚Ññ2: –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã ---
  generate_and_publish:
    # –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π
    needs: prepare
    
    permissions:
      contents: write
      
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞—Ç—Ä–∏—Ü—É, —Å–æ–∑–¥–∞–Ω–Ω—É—é –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ
      matrix:
        thread: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: ‚¨áÔ∏è Checkout repo (Thread ${{ matrix.thread }})
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ‚öôÔ∏è Setup Node.js (Thread ${{ matrix.thread }})
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies (Thread ${{ matrix.thread }})
        run: npm install

      - name: üîë Set API Key for Thread ${{ matrix.thread }}
        id: set_key
        run: |
          API_KEYS="${{ secrets.GEMINI_API_KEYS_POOL }}"
          CURRENT_KEY=$(echo "$API_KEYS" | awk "NR==${{ matrix.thread }}")
          if [[ -z "$CURRENT_KEY" ]]; then
            echo "::error::–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å API-–∫–ª—é—á –¥–ª—è –ø–æ—Ç–æ–∫–∞ #${{ matrix.thread }}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–∫—Ä–µ—Ç GEMINI_API_KEYS_POOL."
            exit 1
          fi
          echo "key=$CURRENT_KEY" >> $GITHUB_OUTPUT

      - name: üè≠ Run Factory & üì¢ Publish & Notify (Thread ${{ matrix.thread }})
        env:
          GEMINI_API_KEY_CURRENT: ${{ steps.set_key.outputs.key }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size_per_thread }}
          TOTAL_THREADS: ${{ github.event.inputs.threads }}
          THREAD_ID: ${{ matrix.thread }}
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@github.com'
          
          echo "--- –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread }}: –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é ---"
          
          git pull --rebase
          npm run factory
          
          if [[ -z $(git status --porcelain) ]]; then
            echo "‚úÖ –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread }}: –ù–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ú–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
            exit 0
          fi

          echo "üî• –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread }}: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã. –ü—É–±–ª–∏–∫—É—é –ø–∞—á–∫—É..."
          git add src/content/posts/*.md
          git commit -m "üöÄ –ê–≤—Ç–æ-–ø—É–±–ª–∏–∫–∞—Ü–∏—è: –ø–∞—á–∫–∞ –æ—Ç –≠—Å–∫–∞–¥—Ä–æ–Ω–∞ ‚Ññ${{ matrix.thread }}"
          
          git pull --rebase
          git push
          
          commit_after=$(git rev-parse HEAD)
          
          # –ù–∞–º –Ω—É–∂–µ–Ω commit_before, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –¥–æ –ø–µ—Ä–≤–æ–≥–æ pull
          # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏, –º—ã –≤–æ–∑—å–º–µ–º –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç
          commit_before=$(git rev-parse HEAD~1)
          
          NEW_FILES=$(git diff --name-only $commit_before $commit_after -- 'src/content/posts/*.md')
          
          URL_LIST=""
          for file in $NEW_FILES; do
            slug=$(basename $file .md)
            url="https://butlerspb-blog.netlify.app/blog/${slug}/"
            URL_LIST="${URL_LIST}${url}\n"
          done

          if [[ -n "$URL_LIST" ]]; then
            echo "üì¢ –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread }}: –û—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ IndexNow..."
            API_KEY="d1b055ab1eb146d892169bbb2c96550e"
            HOST="butlerspb-blog.netlify.app"
            
            JSON_PAYLOAD=$(jq -n \
                            --arg host "$HOST" \
                            --arg key "$API_KEY" \
                            --arg urls_string "$URL_LIST" \
                            '{host: $host, key: $key, urlList: ($urls_string | split("\n") | map(select(length > 0)))}'
                            )
            
            curl -X POST "https://yandex.com/indexnow" -H "Content-Type: application/json; charset=utf-8" -d "$JSON_PAYLOAD"
            curl -X POST "https://www.bing.com/indexnow" -H "Content-Type: application/json; charset=utf-8" -d "$JSON_PAYLOAD"
          fi
          
          echo -e "\n‚úÖ –≠–°–ö–ê–î–†–û–ù #${{ matrix.thread }}: –ú–∏—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
