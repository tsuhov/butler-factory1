name: ğŸš€ Content Factory (Bulletproof Batch Push v2)

on:
  workflow_dispatch:
    inputs:
      model_choice:
        description: 'ĞšĞ°ĞºÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸?'
        required: true
        default: 'gemini'
        type: choice
        options:
        - gemini
        - deepseek
      batch_size_per_thread:
        description: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ°Ñ‚ĞµĞ¹ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞšĞĞ–Ğ”Ğ«Ğœ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ¼?'
        required: true
        default: '10'
      threads:
        description: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ² Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞĞ”ĞĞĞ’Ğ Ğ•ĞœĞ•ĞĞĞ (1-20)?'
        required: true
        default: '5'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
    steps:
      - name: Create thread matrix
        id: set_matrix
        run: |
          MAX_THREADS=20
          REQUESTED_THREADS=${{ github.event.inputs.threads || 5 }}
          
          if (( REQUESTED_THREADS > MAX_THREADS )); then
            echo "::warning::Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑˆĞµĞ½Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ² (${REQUESTED_THREADS}), Ñ‡ĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ ĞºĞ»ÑÑ‡ĞµĞ¹ (${MAX_THREADS}). Ğ‘ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ ${MAX_THREADS}."
            REQUESTED_THREADS=$MAX_THREADS
          fi

          MATRIX=$(jq -cn --argjson n "$REQUESTED_THREADS" '[range(1; $n + 1)]')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  generate:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        thread: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ”‘ Set API Key
        id: set_key
        run: |
          MODEL_CHOICE="${{ github.event.inputs.model_choice || 'gemini' }}"
          if [ "$MODEL_CHOICE" == "deepseek" ]; then
            API_KEYS="${{ secrets.OPENROUTER_API_KEYS_POOL }}"
          else
            API_KEYS="${{ secrets.GEMINI_API_KEYS_POOL }}"
          fi
          CURRENT_KEY=$(echo "$API_KEYS" | sed -n '${{ matrix.thread }}p' | tr -d '\r')
          if [[ -z "$CURRENT_KEY" ]]; then
            echo "::error::ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ API-ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° #${{ matrix.thread }}."
            exit 1
          fi
          echo "key=$CURRENT_KEY" >> $GITHUB_OUTPUT

      - name: ğŸ­ Run Factory (Thread ${{ matrix.thread }})
        env:
          MODEL_CHOICE: ${{ github.event.inputs.model_choice || 'gemini' }}
          API_KEY_CURRENT: ${{ steps.set_key.outputs.key }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size_per_thread || 10 }}
          TOTAL_THREADS: ${{ github.event.inputs.threads || 5 }}
          THREAD_ID: ${{ matrix.thread }}
        run: npm run factory

      - name: ğŸ“¤ Upload generated articles
        uses: actions/upload-artifact@v4
        with:
          name: generated-posts-thread-${{ matrix.thread }}
          path: src/content/posts/*.md
          if-no-files-found: ignore

  publish_and_notify:
    if: ${{ always() }} 
    needs: generate
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Download all generated articles
        uses: actions/download-artifact@v4
        with:
          path: src/content/posts
          merge-multiple: true

      - name: ğŸš€ Commit, Push & Notify
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # <-- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git config --global pull.rebase true

          if [[ -z $(git status --porcelain src/content/posts/) ]]; then
            echo "âœ… ĞĞ¾Ğ²Ñ‹Ñ… ÑÑ‚Ğ°Ñ‚ĞµĞ¹ Ğ´Ğ»Ñ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾."
            exit 0
          fi

          echo "ğŸ”¥ ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹. ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ñƒ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸..."
          git pull
          
          NEW_FILES=$(git status --porcelain src/content/posts/ | grep '^??' | awk '{print $2}')
          
          git add src/content/posts/*.md
          git commit -m "ğŸš€ ĞĞ²Ñ‚Ğ¾-Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ: Ğ¿Ğ°ĞºĞµÑ‚Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°"
          
          # Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ğ´Ğ»Ñ push
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:main

          if [[ -n "$NEW_FILES" ]]; then
            echo "ğŸ“¢ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ IndexNow..."
            API_KEY="d1b055ab1eb146d892169bbb2c96550e"
            HOST="butlerspb-blog.netlify.app"
            URL_JSON_ARRAY=$(for file in $NEW_FILES; do slug=$(basename "$file" .md); echo "https://butlerspb-blog.netlify.app/blog/${slug}/"; done | jq -R . | jq -s .)
            JSON_PAYLOAD=$(jq -n --arg host "$HOST" --arg key "$API_KEY" --argjson urls "$URL_JSON_ARRAY" '{host: $host, key: $key, urlList: $urls}')
            
            echo "--- Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ°ĞºĞµÑ‚Ğ° Ğ´Ğ»Ñ IndexNow ---"
            echo "$JSON_PAYLOAD"
            echo "--- ĞšĞ¾Ğ½ĞµÑ† Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸ ---"
            
            curl -X POST "https://yandex.com/indexnow" -H "Content-Type: application/json; charset=utf-8" -d "$JSON_PAYLOAD"
            curl -X POST "https://www.bing.com/indexnow" -H "Content-Type: application/json; charset=utf-8" -d "$JSON_PAYLOAD"
          fi
          
          echo -e "\nâœ… ĞœĞ¸ÑÑĞ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°."
